name: Golden Gate CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  RAILWAY_VOLUME_MOUNT_PATH: /tmp
  PYTHONUNBUFFERED: "1"

jobs:
  golden-gate:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Run Golden Gate (Unit Tests)
        run: |
          echo "Running unit tests only (no API key in CI)"
          SKIP_LIVE=1 ./scripts/ci_golden_gate.sh

      - name: Live Validation (on main only)
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        env:
          API_KEY: ${{ secrets.API_KEY }}
        run: |
          if [ -n "$API_KEY" ]; then
            echo "Running live validation against production..."
            python3 scripts/golden_run.py validate
          else
            echo "API_KEY secret not set - skipping live validation"
          fi

  contract-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt
          pip install pytest

      - name: Golden Run Contract Tests
        env:
          RAILWAY_VOLUME_MOUNT_PATH: /tmp
        run: |
          python -m pytest tests/test_golden_run.py -v --tb=short

      - name: Output Boundary Tests
        env:
          RAILWAY_VOLUME_MOUNT_PATH: /tmp
        run: |
          python -m pytest tests/test_debug_telemetry.py -v --tb=short

      - name: Integration Contract Tests
        env:
          RAILWAY_VOLUME_MOUNT_PATH: /tmp
        run: |
          python -m pytest tests/test_integration_validation.py -v --tb=short

  freeze-verify:
    runs-on: ubuntu-latest
    needs: [golden-gate, contract-tests]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Wait for Railway Deploy
        run: |
          echo "Waiting 3 minutes for Railway auto-deploy..."
          sleep 180

      - name: Verify Deployment
        env:
          API_KEY: ${{ secrets.API_KEY }}
          API_BASE: https://web-production-7b2a.up.railway.app
        run: |
          if [ -z "$API_KEY" ]; then
            echo "API_KEY secret not set - skipping freeze verification"
            exit 0
          fi

          # Get expected SHA from this commit
          EXPECTED_SHA=$(git rev-parse --short HEAD)
          echo "Expected build SHA: $EXPECTED_SHA"

          # Run freeze verification
          ./scripts/freeze_verify.sh

--- Phase 4: Wire Hurst Exponent & Fibonacci Retracement (v17.7)
--- Apply to: live_data_router.py

================================================================================
PATCH 1: Add imports at top of file (after existing imports)
================================================================================

--- live_data_router.py (imports section)
+++ live_data_router.py (imports section)

# Add to existing imports (combine with any existing database imports):
+from database import get_db, get_line_history_values, get_season_extreme, DB_ENABLED
+from esoteric_engine import calculate_fibonacci_retracement


================================================================================
PATCH 2: Fetch line history before GLITCH call (~line 3340)
================================================================================

--- live_data_router.py:3340
+++ live_data_router.py:3340

# Insert BEFORE the existing GLITCH call (around line 3340):

+            # ===== v17.7: HURST EXPONENT DATA =====
+            _line_history = None
+            try:
+                _event_id = candidate.get("id") if isinstance(candidate, dict) else None
+                if _event_id and DB_ENABLED:
+                    with get_db() as db:
+                        if db:
+                            _line_history = get_line_history_values(
+                                db,
+                                event_id=_event_id,
+                                value_type="spread",  # Use spread for game picks, could use "total"
+                                limit=30
+                            )
+            except Exception as e:
+                logger.debug("Line history fetch skipped: %s", e)


================================================================================
PATCH 3: Update GLITCH call to pass line_history (~line 3347)
================================================================================

--- live_data_router.py:3347 (existing GLITCH call)
+++ live_data_router.py:3347 (updated GLITCH call)

# CHANGE the line_history parameter from None to _line_history:

             glitch_result = get_glitch_aggregate(
                 birth_date_str=_player_birth,
                 game_date=_game_date_obj,
                 game_time=game_datetime,
-                line_history=None,
+                line_history=_line_history,  # v17.7: Wire to line_snapshots data
                 value_for_benford=_line_values if len(_line_values) >= 10 else None,
                 primary_value=prop_line if prop_line else spread
             )


================================================================================
PATCH 4: Add Fibonacci Retracement section (~line 3590, after existing Fib)
================================================================================

--- live_data_router.py:3590 (after existing Fibonacci alignment section)
+++ live_data_router.py:3590

# Insert AFTER the existing Fibonacci alignment (Jarvis) section:

+            # ===== v17.7: FIBONACCI RETRACEMENT (Season Extremes) =====
+            try:
+                if DB_ENABLED and _is_game_pick:
+                    # Determine current season (Sept-Aug)
+                    _now = datetime.now()
+                    _season = f"{_now.year}-{str(_now.year+1)[-2:]}" if _now.month >= 9 else f"{_now.year-1}-{str(_now.year)[-2:]}"
+
+                    # Get primary line value
+                    _fib_line = abs(spread) if spread else total if total else None
+                    _fib_stat = "spread" if spread else "total"
+
+                    if _fib_line:
+                        with get_db() as db:
+                            if db:
+                                extremes = get_season_extreme(db, sport, _season, _fib_stat)
+
+                                if extremes and extremes.get("season_high") and extremes.get("season_low"):
+                                    fib_result = calculate_fibonacci_retracement(
+                                        current_line=_fib_line,
+                                        season_high=extremes["season_high"],
+                                        season_low=extremes["season_low"]
+                                    )
+
+                                    if fib_result.get("near_fib_level"):
+                                        _fib_boost = 0.35 if fib_result["signal"] == "REVERSAL_ZONE" else 0.2
+                                        esoteric_raw += _fib_boost
+                                        esoteric_reasons.append(
+                                            f"Fib Retracement: {fib_result['closest_fib_level']}% ({fib_result['signal']})"
+                                        )
+            except Exception as e:
+                logger.debug("Fibonacci retracement skipped: %s", e)

================================================================================
END OF PATCHES
================================================================================
